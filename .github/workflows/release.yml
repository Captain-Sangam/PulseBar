name: Build and Release

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    name: Build and Upload Release Asset
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show Swift version
      run: |
        swift --version
        xcodebuild -version
    
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-release-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-release-
          ${{ runner.os }}-spm-
    
    - name: Resolve dependencies
      run: swift package resolve
      
    - name: Build release binary
      run: swift build -c release -v
      
    - name: Create .app bundle
      run: |
        echo "Creating PulseBar.app bundle..."
        
        # Create app bundle structure
        mkdir -p build/PulseBar.app/Contents/MacOS
        mkdir -p build/PulseBar.app/Contents/Resources
        
        # Copy binary
        cp .build/release/PulseBar build/PulseBar.app/Contents/MacOS/
        chmod +x build/PulseBar.app/Contents/MacOS/PulseBar
        
        # Copy Info.plist
        cp Info.plist build/PulseBar.app/Contents/
        
        # Copy icons
        cp icons/16-mac.png build/PulseBar.app/Contents/Resources/MenuBarIcon.png
        cp icons/32-mac.png build/PulseBar.app/Contents/Resources/MenuBarIcon@2x.png
        cp icons/128-mac.png build/PulseBar.app/Contents/Resources/AppIcon.png
        
        # Set version in Info.plist
        VERSION="${{ github.event.release.tag_name }}"
        sed -i '' "s/<string>1.0<\/string>/<string>${VERSION#v}<\/string>/" build/PulseBar.app/Contents/Info.plist
        
        echo "✓ App bundle created successfully"
        
    - name: Verify app bundle
      run: |
        echo "Verifying app bundle..."
        ls -lah build/PulseBar.app/Contents/MacOS/
        file build/PulseBar.app/Contents/MacOS/PulseBar
        otool -L build/PulseBar.app/Contents/MacOS/PulseBar || true
        
    - name: Create DMG (optional)
      run: |
        echo "Creating distributable archive..."
        cd build
        
        # Create a simple zip for now
        zip -r PulseBar.zip PulseBar.app
        
        # Calculate checksum
        shasum -a 256 PulseBar.zip > PulseBar.zip.sha256
        
        cd ..
        echo "✓ Archive created: PulseBar.zip"
        
    - name: Upload app bundle to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./build/PulseBar.zip
        asset_name: PulseBar-${{ github.event.release.tag_name }}-macOS.zip
        asset_content_type: application/zip
        
    - name: Upload checksum to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./build/PulseBar.zip.sha256
        asset_name: PulseBar-${{ github.event.release.tag_name }}-macOS.zip.sha256
        asset_content_type: text/plain
    
    - name: Release summary
      run: |
        echo "## Release Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Release build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Swift version: $(swift --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
        echo "- Platform: macOS 15 (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
        echo "- Architecture: $(uname -m)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- PulseBar-${{ github.event.release.tag_name }}-macOS.zip" >> $GITHUB_STEP_SUMMARY
        echo "- SHA256 checksum included" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Download and install" >> $GITHUB_STEP_SUMMARY
        echo "unzip PulseBar-${{ github.event.release.tag_name }}-macOS.zip" >> $GITHUB_STEP_SUMMARY
        echo "mv PulseBar.app /Applications/" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
