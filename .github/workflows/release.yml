name: Build and Release

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    name: Build, Sign, Notarize and Upload
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Swift version
        run: |
          swift --version
          xcodebuild -version

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-release-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-release-
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build release binary
        run: swift build -c release -v

      - name: Create .app bundle
        run: |
          echo "Creating PulseBar.app bundle..."

          # Create app bundle structure
          mkdir -p build/PulseBar.app/Contents/MacOS
          mkdir -p build/PulseBar.app/Contents/Resources

          # Copy binary
          cp .build/release/PulseBar build/PulseBar.app/Contents/MacOS/
          chmod +x build/PulseBar.app/Contents/MacOS/PulseBar

          # Copy Info.plist
          cp Info.plist build/PulseBar.app/Contents/

          # Copy icons
          cp icons/16-mac.png build/PulseBar.app/Contents/Resources/MenuBarIcon.png
          cp icons/32-mac.png build/PulseBar.app/Contents/Resources/MenuBarIcon@2x.png
          cp icons/128-mac.png build/PulseBar.app/Contents/Resources/AppIcon.png

          # Set version in Info.plist
          VERSION="${{ github.event.release.tag_name }}"
          sed -i '' "s/<string>1.0<\/string>/<string>${VERSION#v}<\/string>/" build/PulseBar.app/Contents/Info.plist

          echo "✓ App bundle created successfully"

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Set keychain as default
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "✓ Certificate imported successfully"

      - name: Sign app bundle
        env:
          SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          echo "Signing app bundle..."

          # Sign the app with hardened runtime
          codesign --force --deep --options runtime \
            --sign "$SIGNING_IDENTITY" \
            --timestamp \
            build/PulseBar.app

          # Verify signature
          codesign --verify --verbose=4 build/PulseBar.app
          echo "✓ App signed successfully"

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "Creating ZIP for notarization..."
          cd build
          zip -r PulseBar-notarize.zip PulseBar.app
          cd ..

          echo "Submitting to Apple notary service..."
          xcrun notarytool submit build/PulseBar-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          echo "✓ Notarization complete"

      - name: Staple notarization ticket
        run: |
          echo "Stapling notarization ticket..."
          xcrun stapler staple build/PulseBar.app

          # Verify stapling
          xcrun stapler validate build/PulseBar.app
          echo "✓ Notarization ticket stapled"

      - name: Create distributable archive
        run: |
          cd build
          rm -f PulseBar-notarize.zip  # Remove temp notarization zip
          zip -r PulseBar.zip PulseBar.app
          shasum -a 256 PulseBar.zip > PulseBar.zip.sha256
          cd ..
          echo "✓ Archive created: PulseBar.zip"

      - name: Verify final app
        run: |
          echo "Final verification..."
          codesign -dv --verbose=4 build/PulseBar.app
          spctl --assess --type execute --verbose=2 build/PulseBar.app || true
          echo "✓ Verification complete"

      - name: Upload app bundle to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./build/PulseBar.zip
          asset_name: PulseBar-${{ github.event.release.tag_name }}-macOS.zip
          asset_content_type: application/zip

      - name: Upload checksum to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./build/PulseBar.zip.sha256
          asset_name: PulseBar-${{ github.event.release.tag_name }}-macOS.zip.sha256
          asset_content_type: text/plain

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/signing.keychain-db || true
